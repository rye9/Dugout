<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Blacksox Dugout — v1.1 (Multi-Team)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="./mobile-polish.css" rel="stylesheet" />
  <style>
    :root { --brand:#0b3b8c; --ink:#111; --muted:#6b7280; --bg:#f8fafc; }
    .hidden { display:none !important; }
    .tabs { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; }
    .tab-btn { padding:.5rem .75rem; border-radius:.75rem; border:1px solid #e5e7eb; background:#fff; cursor:pointer; }
    .tab-btn[aria-selected="true"] { background:var(--brand); color:#fff; border-color:var(--brand); }
    .toolbar { display:flex; gap:.75rem; align-items:center; padding:.5rem 0; flex-wrap:wrap; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:1rem; padding:1rem; }
    .grid { display:grid; gap:1rem; }
    .grid-3 { grid-template-columns: 1fr; }
    @media (min-width: 900px){ .grid-3 { grid-template-columns: 280px 1fr; } }
    .row { display:flex; gap:.75rem; flex-wrap:wrap; }
    .row > label { display:flex; flex-direction:column; gap:.25rem; font-size:.9rem; }
    input[type="text"], input[type="number"], select, textarea { padding:.5rem .625rem; border:1px solid #e5e7eb; border-radius:.5rem; min-width:6rem; }
    table { width:100%; border-collapse:collapse; }
    th, td { border-bottom:1px solid #eee; padding:.5rem; text-align:left; }
    .soft { color:var(--muted); font-size:.9rem; }
    .pill { display:inline-flex; align-items:center; gap:.4rem; border:1px solid #e5e7eb; padding:.25rem .5rem; border-radius:999px; }
    .btn { padding:.5rem .75rem; border-radius:.6rem; border:1px solid #e5e7eb; background:#fff; cursor:pointer; }
    .btn.primary { background:var(--brand); color:#fff; border-color:var(--brand); }
    .btn.ghost { background:transparent; }
    .table-actions { display:flex; gap:.5rem; }
    .kicker { display:flex; justify-content:space-between; align-items:center; gap:.75rem; }
  </style>
</head>
<body>
  <header class="kicker" style="margin:1rem 0;">
    <h1 style="margin:0;">Blacksox Dugout</h1>
    <span class="soft">v1.1-multiteam</span>
  </header>

  <nav class="tabs" role="tablist" aria-label="Modes">
    <button class="tab-btn" role="tab" aria-selected="true" aria-controls="tab-rosters" id="tabbtn-rosters">Rosters</button>
    <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-single" id="tabbtn-single">Single-Game Builder</button>
    <button class="tab-btn" role="tab" aria-selected="false" aria-controls="tab-tournament" id="tabbtn-tournament">Tournament Mode</button>
  </nav>

  <section id="tab-rosters" role="tabpanel" aria-labelledby="tabbtn-rosters" style="margin-top:1rem;">
    <div class="grid grid-3">
      <div class="card">
        <div class="kicker">
          <h3 style="margin:.25rem 0;">Teams</h3>
          <button class="btn" id="dugout-addTeam">+ New Team</button>
        </div>
        <ul id="dugout-teamList" style="list-style:none; padding:0; margin:.5rem 0 0 0;"></ul>
      </div>
      <div class="card">
        <form id="dugout-teamForm">
          <div class="row">
            <label>Team Name
              <input id="dugout-teamName" type="text" placeholder="Bainbridge Blacksox 10U" required />
            </label>
            <label>Level
              <select id="dugout-teamLevel">
                <option>9U</option><option selected>10U</option><option>11U</option><option>12U</option><option>13U</option>
              </select>
            </label>
            <label>Color (opt)
              <input id="dugout-teamColor" type="text" placeholder="#0b3b8c" />
            </label>
          </div>

          <details style="margin-top:.5rem;">
            <summary><strong>Defaults</strong> <span class="soft"> (per team)</span></summary>
            <div class="row" style="margin-top:.5rem;">
              <label>Pitch Limit
                <input id="dugout-pitchLimit" type="number" min="0" value="85" />
              </label>
              <label>Tournament Max
                <input id="dugout-tournMax" type="number" min="0" value="105" />
              </label>
              <label>Min Def Innings
                <input id="dugout-minDef" type="number" min="0" value="2" />
              </label>
            </div>
          </details>

          <div class="kicker" style="margin-top:1rem;">
            <h4 style="margin:0;">Roster</h4>
            <div class="row">
              <button type="button" class="btn" id="dugout-addPlayer">+ Add Player</button>
              <label class="pill">
                <input type="file" id="dugout-importCsv" accept=".csv" />
                Import CSV
              </label>
              <button type="button" class="btn" id="dugout-exportJson">Export JSON</button>
            </div>
          </div>

          <div style="overflow:auto; max-width:100%;">
            <table id="dugout-rosterTable">
              <thead>
                <tr>
                  <th style="width:64px;">#</th>
                  <th style="min-width:160px;">Name</th>
                  <th>Primary</th>
                  <th>Secondary</th>
                  <th style="width:84px;">Rank</th>
                  <th style="width:64px;"></th>
                </tr>
              </thead>
              <tbody id="dugout-rosterBody"></tbody>
            </table>
          </div>

          <div class="row" style="margin-top:1rem;">
            <button type="submit" class="btn primary">Save Team</button>
            <button type="button" class="btn" id="dugout-deleteTeam">Delete Team</button>
          </div>
          <p class="soft" style="margin-top:.5rem;">Tip: Drag Rank numbers to re-order quickly (or just type).</p>
        </form>
      </div>
    </div>
  </section>

  <section id="tab-single" class="hidden" role="tabpanel" aria-labelledby="tabbtn-single" style="margin-top:1rem;">
    <div class="card">
      <div class="toolbar">
        <label>Roster:
          <select id="dugout-teamSelectSingle"></select>
        </label>
        <span class="soft">Single-game UI will render below using the selected team roster.</span>
      </div>
      <div id="dugout-singleMount" class="soft">If your app defines <code>window.renderSingleGameUI()</code>, it will be called on team switch.</div>
    </div>
  </section>

  <section id="tab-tournament" class="hidden" role="tabpanel" aria-labelledby="tabbtn-tournament" style="margin-top:1rem;">
    <div class="card">
      <div class="toolbar">
        <label>Roster:
          <select id="dugout-teamSelectTourn"></select>
        </label>
        <span class="soft">Tournament UI will render below using the selected team roster.</span>
      </div>
      <div id="dugout-tournMount" class="soft">If your app defines <code>window.renderTournamentUI()</code>, it will be called on team switch.</div>
    </div>
  </section>

  <script>
  (function(){
    const LS_KEY = "dugout_multi_teams_v1";

    // Embedded 12U seed from your CSV
    const SEED_12U = {
      id: "12U-blacksox",
      name: "Bainbridge Blacksox 12U",
      level: "12U",
      color: "#0b3b8c",
      defaults: { pitch_limit: 85, tournament_pitch_max: 105, min_def_innings: 2 },
      roster: [{"num": "24", "name": "Anthony", "primary": "2B", "secondary": "LF", "rank": 6}, {"num": "63", "name": "Jack F", "primary": "3B", "secondary": "1B", "rank": 5}, {"num": "27", "name": "Clark", "primary": "2B", "secondary": "1B", "rank": 9}, {"num": "23", "name": "Nolan", "primary": "CF", "secondary": "LF", "rank": 10}, {"num": "22", "name": "Rowan", "primary": "CF", "secondary": "2B", "rank": 8}, {"num": "77", "name": "Emory", "primary": "RF", "secondary": "LF", "rank": 12}, {"num": "11", "name": "Nicky", "primary": "RF", "secondary": "LF", "rank": 11}, {"num": "21", "name": "Esteban", "primary": "3B", "secondary": "2B", "rank": 7}, {"num": "7", "name": "Manuel", "primary": "SS", "secondary": "3B", "rank": 4}, {"num": "4", "name": "Gray", "primary": "SS", "secondary": "2B", "rank": 2}, {"num": "14", "name": "Jack J", "primary": "SS", "secondary": "2B", "rank": 3}, {"num": "74", "name": "Cole", "primary": "RF", "secondary": "LF", "rank": 13}, {"num": "8", "name": "Wat", "primary": "SS", "secondary": "3B", "rank": 1}],
      updatedAt: Date.now()
    };

    function loadStore() {
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return migrateFromExistingOrSeed();
      try { return JSON.parse(raw); } catch { return migrateFromExistingOrSeed(); }
    }
    function saveStore(store) { localStorage.setItem(LS_KEY, JSON.stringify(store)); }

    function migrateFromExistingOrSeed() {
      const defaultRoster = Array.isArray(window.ROSTER) ? window.ROSTER.map((p,i)=>({
        num: p.num ?? p.number ?? "",
        name: p.name ?? p.player ?? "",
        primary: p.primary ?? p.pos1 ?? "",
        secondary: p.secondary ?? p.pos2 ?? "",
        rank: Number(p.rank ?? (i+1))
      })) : [];
      const id10 = "10U-blacksox";
      const base = {
        teams: [{
          id: id10, name: "Bainbridge Blacksox 10U", level: "10U", color: "#0b3b8c",
          defaults: { pitch_limit: 85, tournament_pitch_max: 105, min_def_innings: 2 },
          roster: defaultRoster, updatedAt: Date.now()
        }, SEED_12U],
        activeTeamId: id10
      };
      return base;
    }

    let store = loadStore();

    function getTeam(id){ return store.teams.find(t=>t.id===id); }
    function getActive(){ return getTeam(store.activeTeamId) || store.teams[0]; }
    function setActive(id){ store.activeTeamId = id; saveStore(store); hydrateTeamSelects(); renderExternalHooks(); renderTeamList(); loadTeamEditor(); }

    // Tabs
    const tabs = [
      {btn:"tabbtn-rosters", panel:"tab-rosters"},
      {btn:"tabbtn-single", panel:"tab-single"},
      {btn:"tabbtn-tournament", panel:"tab-tournament"},
    ];
    function selectTab(idx){
      tabs.forEach((t,i)=>{
        const btn = document.getElementById(t.btn);
        const sec = document.getElementById(t.panel);
        const sel = i===idx;
        btn.setAttribute("aria-selected", sel ? "true":"false");
        sec.classList.toggle("hidden", !sel);
      });
    }
    document.getElementById("tabbtn-rosters").onclick = ()=>selectTab(0);
    document.getElementById("tabbtn-single").onclick = ()=>selectTab(1);
    document.getElementById("tabbtn-tournament").onclick = ()=>selectTab(2);

    // Rosters Tab
    const teamList = document.getElementById("dugout-teamList");
    const teamForm = document.getElementById("dugout-teamForm");
    const rosterBody = document.getElementById("dugout-rosterBody");

    function renderTeamList(){
      teamList.innerHTML = store.teams.map(t=>`
        <li>
          <button class="btn" style="width:100%; justify-content:space-between; display:flex;" data-id="${t.id}">
            <span>${t.name}</span>
            <small class="soft">${t.level}</small>
          </button>
        </li>`).join("");
      teamList.querySelectorAll("button").forEach(b=>{ b.onclick = ()=> setActive(b.dataset.id); });
    }

    function loadTeamEditor(){
      const t = getActive(); if(!t) return;
      document.getElementById("dugout-teamName").value = t.name ?? "";
      document.getElementById("dugout-teamLevel").value = t.level ?? "10U";
      document.getElementById("dugout-teamColor").value = t.color ?? "#0b3b8c";
      document.getElementById("dugout-pitchLimit").value = t.defaults?.pitch_limit ?? 85;
      document.getElementById("dugout-tournMax").value = t.defaults?.tournament_pitch_max ?? 105;
      document.getElementById("dugout-minDef").value = t.defaults?.min_def_innings ?? 2;
      renderRosterRows(t.roster || []);
    }

    function rowTemplate(p,i){
      return `<tr data-index="${i}">
        <td><input class="cell num" type="text" inputmode="numeric" value="${p.num ?? ""}" /></td>
        <td><input class="cell name" type="text" value="${p.name ?? ""}" /></td>
        <td><input class="cell primary" type="text" value="${p.primary ?? ""}" /></td>
        <td><input class="cell secondary" type="text" value="${p.secondary ?? ""}" /></td>
        <td><input class="cell rank" type="number" value="${Number(p.rank ?? (i+1))}" /></td>
        <td class="table-actions"><button type="button" class="btn ghost del">✕</button></td>
      </tr>`;
    }
    function renderRosterRows(roster){
      rosterBody.innerHTML = (roster||[]).map(rowTemplate).join("");
    }

    document.getElementById("dugout-addPlayer").onclick = ()=>{
      const t = getActive(); t.roster = t.roster || [];
      t.roster.push({ num:"", name:"", primary:"", secondary:"", rank: (t.roster.length+1) });
      renderRosterRows(t.roster);
    };

    rosterBody.addEventListener("click", (e)=>{
      if(e.target.classList.contains("del")){
        const idx = Number(e.target.closest("tr").dataset.index);
        const t = getActive(); t.roster.splice(idx,1); renderRosterRows(t.roster);
      }
    });

    teamForm.onsubmit = (e)=>{
      e.preventDefault();
      const t = getActive(); if(!t) return;
      t.name = document.getElementById("dugout-teamName").value.trim() || t.name;
      t.level = document.getElementById("dugout-teamLevel").value;
      t.color = document.getElementById("dugout-teamColor").value || "#0b3b8c";
      t.defaults = {
        pitch_limit: Number(document.getElementById("dugout-pitchLimit").value)||85,
        tournament_pitch_max: Number(document.getElementById("dugout-tournMax").value)||105,
        min_def_innings: Number(document.getElementById("dugout-minDef").value)||2
      };
      const rows = [...rosterBody.querySelectorAll("tr")];
      t.roster = rows.map(r=>({
        num: r.querySelector(".num").value.trim(),
        name: r.querySelector(".name").value.trim(),
        primary: r.querySelector(".primary").value.trim(),
        secondary: r.querySelector(".secondary").value.trim(),
        rank: Number(r.querySelector(".rank").value || 999)
      })).sort((a,b)=> (a.rank||999) - (b.rank||999));
      t.updatedAt = Date.now();
      saveStore(store);
      renderTeamList();
      hydrateTeamSelects();
      alert("Team saved ✔");
    };

    document.getElementById("dugout-addTeam").onclick = ()=>{
      const id = `team-${Math.random().toString(36).slice(2,8)}`;
      store.teams.push({
        id, name:"New Team", level:"10U", color:"#0b3b8c",
        defaults:{ pitch_limit:85, tournament_pitch_max:105, min_def_innings:2 },
        roster:[], updatedAt: Date.now()
      });
      setActive(id);
    };

    document.getElementById("dugout-deleteTeam").onclick = ()=>{
      const id = store.activeTeamId;
      if(!confirm("Delete this team?")) return;
      store.teams = store.teams.filter(t=>t.id!==id);
      if(store.teams.length===0){ store = migrateFromExistingOrSeed(); }
      saveStore(store);
      setActive(store.activeTeamId);
      renderTeamList();
      loadTeamEditor();
      hydrateTeamSelects();
    };

    // Import / Export
    document.getElementById("dugout-exportJson").onclick = ()=>{
      const blob = new Blob([JSON.stringify(store, null, 2)], {type:'application/json'});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "dugout-teams.json";
      a.click();
      URL.revokeObjectURL(a.href);
    };

    document.getElementById("dugout-importCsv").addEventListener("change", async (ev)=>{
      const file = ev.target.files?.[0]; if(!file) return;
      const text = await file.text();
      const lines = text.split(/\r?\n/).filter(Boolean);
      if(lines.length < 2) { alert("CSV seems empty."); return; }

      const header = lines[0].split(",").map(h=>h.trim().toLowerCase());
      const rows = lines.slice(1).map(l => l.split(","));
      const pick = (cols, ...aliases)=>{ for(const a of aliases){ const idx = header.indexOf(a); if(idx>-1) return (cols[idx]||"").trim(); } return ""; };
      const roster = rows.map((cols,i)=>({
        num: pick(cols,"num","#","number"),
        name: pick(cols,"name","player","player_name","first last"),
        primary: pick(cols,"primary","pos1","primary_pos","position","primary position"),
        secondary: pick(cols,"secondary","pos2","secondary_pos"),
        rank: Number(pick(cols,"rank","order","priority") || (i+1))
      })).filter(r=>r.name);

      const t = getActive(); t.roster = roster; t.updatedAt = Date.now();
      saveStore(store);
      renderRosterRows(t.roster);
      alert(`Imported ${roster.length} players ✔`);
      ev.target.value = "";
    });

    function hydrateTeamSelects(){
      const opts = store.teams.map(t=> `<option value="${t.id}">${t.name}</option>`).join("");
      ["dugout-teamSelectSingle","dugout-teamSelectTourn"].forEach(id=>{
        const sel = document.getElementById(id);
        if(!sel) return;
        sel.innerHTML = opts;
        sel.value = store.activeTeamId;
        sel.onchange = (e)=> setActive(e.target.value);
      });
    }

    function renderExternalHooks(){
      const team = getActive();
      window.CURRENT_ROSTER = (team?.roster)||[];
      window.CURRENT_DEFAULTS = (team?.defaults)||{ pitch_limit:85, tournament_pitch_max:105, min_def_innings:2 };
      window.CURRENT_TEAM = { id: team?.id, name: team?.name, level: team?.level, color: team?.color };

      if(typeof window.renderSingleGameUI === "function") window.renderSingleGameUI(document.getElementById("dugout-singleMount"));
      if(typeof window.renderTournamentUI === "function") window.renderTournamentUI(document.getElementById("dugout-tournMount"));
    }

    // Init
    renderTeamList();
    loadTeamEditor();
    hydrateTeamSelects();
    renderExternalHooks();
    selectTab(0);
  })();
  </script>
</body>
</html>
